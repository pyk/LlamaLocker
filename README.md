# Llama Locker

Llama Locker allows users to lock their LLAMA tokens and earn a share of the
yield generated by the treasury over time. It manages epochs, reward token
distribution, and token locking/unlocking, ensuring fair and transparent reward
distribution.

## Lock Mechanism

- Locked NFTs cannot be withdrawn for 4 epochs (4 weeks) and are eligible to
  receive a proportionate share of yields during this period.
- Unlike the CVX Lock style, which requires active kicking out of tokens after
  the lock duration ends, LlamaLocker offers a more user-friendly approach.
- NFT owners can withdraw their NFTs in the epoch after the lock duration ends.
  If not withdrawn, the NFTs will automatically re-lock for the subsequent lock
  duration, streamlining the process and saving users on gas costs.

### Example of Lock Mechanism

1. Alice locks Llama #1 on January 28, 2024, at 22:49:42 GMT.
2. Llama #1 starts accruing yields from February 1, 2024, at 00:00:00 GMT (next epoch).
3. Withdrawal of Llama #1 is possible anytime from February 29, 2024, at 00:00:00 GMT to March 7, 2024, at 00:00:00 GMT (one-week epoch).
4. If Llama #1 remains unwithdrawn during this window, it will automatically re-lock starting March 7, 2024, at 00:00:00 GMT.

## Getting Started

Ensure you are using the latest version of Foundry:

```shell
foundryup
```

Install dependencies:

```shell
forge install
```

Run the tests:

```shell
forge test
```

Example output:

```
$ forge test
[⠊] Compiling...
No files changed, compilation skipped

Ran 1 test for test/LlamaLocker.t.sol:LlamaLockerTest
[PASS] test_renounceOwnership_InvalidAction() (gas: 13344)
Suite result: ok. 1 passed; 0 failed; 0 skipped; finished in 1.21ms (61.08µs CPU time)

Ran 4 tests for test/AddRewardTokens.t.sol:AddRewardTokensTest
[PASS] test_addRewardTokens_InvalidRewardToken() (gas: 92123)
[PASS] test_addRewardTokens_InvalidRewardTokenCount() (gas: 13930)
[PASS] test_addRewardTokens_Unauthorized() (gas: 14167)
[PASS] test_addRewardTokens_Valid() (gas: 133253)
Suite result: ok. 4 passed; 0 failed; 0 skipped; finished in 1.37ms (325.04µs CPU time)

Ran 6 tests for test/LockMechanism.t.sol:LockMechanismTest
[PASS] test_lock_InvalidTokenCount() (gas: 9181)
[PASS] test_lock_Valid() (gas: 448617)
[PASS] test_unlock_InvalidLockOwner() (gas: 223227)
[PASS] test_unlock_InvalidTokenCount() (gas: 9181)
[PASS] test_unlock_InvalidUnlockWindow() (gas: 243021)
[PASS] test_unlock_ValidUnlockWindow() (gas: 215742)
Suite result: ok. 6 passed; 0 failed; 0 skipped; finished in 1.56ms (1.02ms CPU time)

Ran 5 tests for test/RewardDistribution.t.sol:RewardDistributionTest
[PASS] test_distributeRewardToken_Claimables() (gas: 968837)
[PASS] test_distributeRewardToken_InvalidRewardAmount() (gas: 134450)
[PASS] test_distributeRewardToken_InvalidRewardToken() (gas: 17532)
[PASS] test_distributeRewardToken_InvalidTotalShares() (gas: 136540)
[PASS] test_distributeRewardToken_Unauthorized() (gas: 13833)
Suite result: ok. 5 passed; 0 failed; 0 skipped; finished in 1.76ms (1.22ms CPU time)

Ran 4 test suites in 513.25ms (5.90ms CPU time): 16 tests passed, 0 failed, 0 skipped (16 total tests)
```

## Front End Integration

There are two main actions for users:

1. **Lock NFT:** Users can lock their NFT via `lock`.
2. **Unlock NFT:** Users can unlock their NFT via `unlock`.

Additional information:

- Claimable rewards are available via `claimables(account)`.
- Claimed rewards are available via `getClaimedRewards(account)`.
- Lock information can be retrieved via `locks(nftId)`.

To compute the next unlock for the specified NFT, use the following formula:

```shell
lockedDuration = currentTimestamp - lockedAt
lockedDurationInEpoch = lockedDuration / EPOCH_DURATION
modulo = lockedDurationInEpoch % LOCK_DURATION_IN_EPOCH
unlockNextEpoch = LOCK_DURATION_IN_EPOCH - modulo
unlockStart = currentTimestamp + (unlockNextEpoch * EPOCH_DURATION)
unlockEnd = unlockStart + EPOCH_DURATION
```

`unlockStart` and `unlockEnd` define a time window in Unix timestamp when users can unlock their locked NFTs.

## Admin Chores

- Admins can add a new reward token via `addRewardToken`.
- Admins can distribute weekly rewards via `distributeRewardToken`.
- Admins need to approve the LlamaLocker contract before executing `distributeRewardToken`.
