# Llama Locker

Llama Locker allows users to lock their LLAMA tokens and earn a share of the
yield generated by the treasury over time. It manages epochs, reward token
distribution, and token locking/unlocking, ensuring fair and transparent reward
distribution.

## Lock Mechanism

- Locked NFTs cannot be withdrawn for 4 epochs (4 weeks) and are eligible to
  receive a proportionate share of yields during this period.
- Unlike the CVX Lock style, which requires active kicking out of tokens after
  the lock duration ends, LlamaLocker offers a more user-friendly approach.
- NFT owners can withdraw their NFTs in the epoch after the lock duration ends.
  If not withdrawn, the NFTs will automatically re-lock for the subsequent lock
  duration, streamlining the process and saving users on gas costs.

### Example of Lock Mechanism

1. Alice locks Llama #1 on January 28, 2024, at 22:49:42 GMT.
2. Llama #1 starts accruing yields from February 1, 2024, at 00:00:00 GMT (next epoch).
3. Withdrawal of Llama #1 is possible anytime from February 29, 2024, at 00:00:00 GMT to March 7, 2024, at 00:00:00 GMT (one-week epoch).
4. If Llama #1 remains unwithdrawn during this window, it will automatically re-lock starting March 7, 2024, at 00:00:00 GMT.

## Getting Started

Ensure you are using the latest version of Foundry:

```shell
foundryup
```

Install dependencies:

```shell
forge install
```

Run the tests:

```shell
forge test
```

Example output:

```
$ forge test
[⠊] Compiling...
[⠘] Compiling 1 files with Solc 0.8.23
[⠃] Solc 0.8.23 finished in 1.81s
Compiler run successful!

Ran 8 tests for test/Whitelist.t.sol:RewardDistributionTest
[PASS] test_disableWhitelist_InvalidAction() (gas: 20255)
[PASS] test_disableWhitelist_Unauthorized() (gas: 13677)
[PASS] test_disableWhitelist_Valid() (gas: 19431)
[PASS] test_lock_InvalidAction() (gas: 115236)
[PASS] test_lock_Valid() (gas: 222819)
[PASS] test_setRoot_InvalidAction() (gas: 15605)
[PASS] test_setRoot_Unauthorized() (gas: 13717)
[PASS] test_setRoot_Valid() (gas: 19647)
Suite result: ok. 8 passed; 0 failed; 0 skipped; finished in 10.53ms (848.79µs CPU time)

Ran 1 test for test/LlamaLocker.t.sol:LlamaLockerTest
[PASS] test_renounceOwnership_InvalidAction() (gas: 13344)
Suite result: ok. 1 passed; 0 failed; 0 skipped; finished in 10.54ms (480.79µs CPU time)

Ran 4 tests for test/AddRewardTokens.t.sol:AddRewardTokensTest
[PASS] test_addRewardTokens_InvalidRewardToken() (gas: 92126)
[PASS] test_addRewardTokens_InvalidRewardTokenCount() (gas: 13931)
[PASS] test_addRewardTokens_Unauthorized() (gas: 14168)
[PASS] test_addRewardTokens_Valid() (gas: 133254)
Suite result: ok. 4 passed; 0 failed; 0 skipped; finished in 9.61ms (987.75µs CPU time)

Ran 5 tests for test/RewardDistribution.t.sol:RewardDistributionTest
[PASS] test_distributeRewardToken_Claimables() (gas: 971608)
[PASS] test_distributeRewardToken_InvalidRewardAmount() (gas: 134452)
[PASS] test_distributeRewardToken_InvalidRewardToken() (gas: 17533)
[PASS] test_distributeRewardToken_InvalidTotalShares() (gas: 136542)
[PASS] test_distributeRewardToken_Unauthorized() (gas: 13834)
Suite result: ok. 5 passed; 0 failed; 0 skipped; finished in 10.59ms (1.80ms CPU time)

Ran 6 tests for test/LockMechanism.t.sol:LockMechanismTest
[PASS] test_lock_InvalidTokenCount() (gas: 11476)
[PASS] test_lock_Valid() (gas: 449598)
[PASS] test_unlock_InvalidLockOwner() (gas: 223593)
[PASS] test_unlock_InvalidTokenCount() (gas: 9220)
[PASS] test_unlock_InvalidUnlockWindow() (gas: 243582)
[PASS] test_unlock_ValidUnlockWindow() (gas: 216046)
Suite result: ok. 6 passed; 0 failed; 0 skipped; finished in 9.69ms (1.18ms CPU time)

Ran 5 test suites in 719.53ms (50.95ms CPU time): 24 tests passed, 0 failed, 0 skipped (24 total tests)
```

## Generate Merkle Tree

Install dependencies:

```sh
pnpm install
```

Update the `whitelist.txt` file.

Then get the merkle tree root and proofs via the following command:

```sh
pnpm run gen:merkle
```

Check the proof inside `merkle-proofs.json`.

## Front End Integration

There are two main actions for users:

1. **Lock NFT:** Users can lock their NFT via `lock(proofs, tokenIds)`
   for whitelisted user and `lock(tokenIds)` for public.
2. **Unlock NFT:** Users can unlock their NFT via `unlock`.

Additional information:

- Claimable rewards are available via `claimables(account)`.
- Claimed rewards are available via `getClaimedRewards(account)`.
- Lock information can be retrieved via `locks(nftId)`.

To compute the next unlock for the specified NFT, use the following formula:

```shell
lockedDuration = currentTimestamp - lockedAt
lockedDurationInEpoch = lockedDuration / EPOCH_DURATION
modulo = lockedDurationInEpoch % LOCK_DURATION_IN_EPOCH
unlockNextEpoch = LOCK_DURATION_IN_EPOCH - modulo
unlockStart = currentTimestamp + (unlockNextEpoch * EPOCH_DURATION)
unlockEnd = unlockStart + EPOCH_DURATION
```

`unlockStart` and `unlockEnd` define a time window in Unix timestamp when users can unlock their locked NFTs.

Admin actions:

- Admin can add a new reward token via `addRewardToken`.
- Admin can distribute weekly rewards via `distributeRewardToken`.
- Admin need to approve the LlamaLocker contract before executing `distributeRewardToken`.
- Admin can set new merkle tree root via `setRoot(root)` (for rolling whitelist)
- Admin can disable the whitelist via `disableWhitelist()` (for public launch)
